<!--
  Purpose: Protected page where logged-in users can upload CSV files.
  - Verifies login using localStorage.
  - Sends the CSV to FastAPI /predict.
  - Stores the API JSON in sessionStorage and redirects to prediction.html.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload CSV</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-screen w-screen bg-gradient-to-br from-gray-800 to-black flex justify-center items-center">

  <div class="bg-white/10 backdrop-blur-md rounded-3xl p-10 w-full max-w-3xl text-center">
    <!-- Top bar: user info + logout -->
    <div class="flex justify-between items-center mb-4">
      <p class="text-sm text-white">
        Logged in as: <span id="loggedInUser" class="font-semibold">User</span>
      </p>
      <button id="logoutBtn"
        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-full">
        Logout
      </button>
    </div>

    <h2 class="text-2xl font-bold text-white mb-6">Upload CSV File</h2>

    <!-- Drag & Drop upload area -->
    <div id="dropZone"
      class="bg-white/20 border-2 border-dashed border-white/50 rounded-xl p-10 text-white mb-4 cursor-pointer"
    >
      <svg class="w-16 h-16 mb-4 mx-auto" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M4 12l4-4m0 0l4 4m-4-4v12" />
      </svg>
      <p class="text-lg font-medium">Drag and Drop your CSV Files here</p>
      <p class="text-md">or Click To Browse</p>
      <input type="file" id="fileInput" accept=".csv" class="hidden" />
    </div>

    <!-- Browse button -->
    <button id="browseBtn"
      class="bg-gradient-to-r from-gray-700 to-black py-3 px-9 text-white rounded-full mb-4">
      Browse Files
    </button>

    <!-- Upload status -->
    <div id="uploadStatus" class="text-white mt-4 min-h-6"></div>
  </div>

  <script>
    // ===== Login protection =====
    const loggedInUser = localStorage.getItem("loggedInUser");
    if (!loggedInUser) {
      alert("You must log in first!");
      window.location.href = "login.html";
    } else {
      document.getElementById("loggedInUser").textContent = loggedInUser;
    }

    // ===== Logout =====
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedInUser");
      window.location.href = "index.html";
    });

    // ===== Elements =====
    const fileInput = document.getElementById("fileInput");
    const dropZone = document.getElementById("dropZone");
    const browseBtn = document.getElementById("browseBtn");
    const uploadStatus = document.getElementById("uploadStatus");

    // ===== API config =====
    const ML_API_BASE_URL = window.location.hostname === "localhost"
      ? "http://127.0.0.1:8000"
      : "https://fyp-website-3.onrender.com";  // FastAPI on Render
    const API_URL = `${ML_API_BASE_URL}/predict`;

    async function postFileToAPI(file) {
      const formData = new FormData();
      formData.append("file", file);

      uploadStatus.innerHTML = `<span class="text-gray-200">Uploading <strong>${file.name}</strong></span>`;
      browseBtn.disabled = true;
      dropZone.classList.add("pointer-events-none", "opacity-60");

      const res = await fetch(API_URL, { method: "POST", body: formData });

      browseBtn.disabled = false;
      dropZone.classList.remove("pointer-events-none", "opacity-60");

      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || "Upload failed");
      }
      return res.json();
    }

    async function handleFile(file) {
      if (!file) return;
      if (!file.name.toLowerCase().endsWith(".csv")) {
        uploadStatus.innerHTML = `<span class="text-yellow-300">Please upload a .csv file.</span>`;
        return;
      }
      try {
        const result = await postFileToAPI(file);
        uploadStatus.innerHTML = `<span class="text-green-400 font-semibold">${file.name} processed successfully. Redirecting...</span>`;
        sessionStorage.setItem("predictionResult", JSON.stringify(result));
        window.location.href = "prediction.html";
      } catch (err) {
        uploadStatus.innerHTML = `<div class="text-red-400 mt-2 break-words">Error: ${err.message}</div>`;
      }
    }

    // ===== Drag & drop & browse =====
    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", (e) => e.preventDefault());
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      const file = e.dataTransfer.files?.[0];
      handleFile(file);
    });
    browseBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      handleFile(file);
    });
  </script>
</body>
</html>
